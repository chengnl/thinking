Raft一致性算法分析

# 复制状态机
复制状态机通常是基于复制日志实现，保证所有的服务器执行相同的指令序列，从而保证每个服务器最终产生的结果相同。

一致性算法管理客户端指令的复制日志，状态机从日志中处理相同顺序的相同指令，产生相同的结果。

一致性算法特性：  
*  安全保证：各种网络问题，都可保证正确
*  可用性：超过半数可用；稳定存储可恢复
*  不依赖时序来保证一致性：小部分比较慢节点不会影响系统整理性能。

# Raft一致性算法
通过领导人机制，简化复制日志管理，raft将一致性问题分解成：
*  领导选举
*  日志复制
*  安全性

# Raft基础
## 状态切换
每个服务器三种状态：领导人、跟随者或者候选人  
![状态图](https://github.com/chengnl/thinking/raw/master/images-folder/raft_state.png)  
服务器状态：跟随者只响应来自其他服务器的请求。如果跟随者接收不到消息，那么他就会变成候选人并发起一次选举。获得集群中大多数选票的候选人将成为领导者。领导人一直都会是领导人直到自己宕机了

## 领导任期
Raft 把时间分割成任意长度的任期
![任期图](https://github.com/chengnl/thinking/raw/master/images-folder/raft_term.png) 
任期用连续的整数标记。每一段任期从一次选举开始，一个或者多个候选人尝试成为领导者。如果一个候选人赢得选举，然后他就在接下来的任期内充当领导人的职责。在某些情况下，一次选举过程会造成选票的瓜分。在这种情况下，这一任期会以没有领导人结束；一个新的任期（和一次新的选举）会很快重新开始。Raft 保证了在一个给定的任期内，最多只有一个领导者。

## 节点远程调用（RPCs）
请求投票（RequestVote） RPCs 由候选人在选举期间发起），然后附加条目（AppendEntries）RPCs 由领导人发起，用来复制日志和提供一种心跳机制。为了在服务器之间传输快照增加了第三种 RPC。当服务器没有及时的收到 RPC 的响应时，会进行重试， 并且他们能够并行的发起 RPCs 来获得最佳的性能。

# 领导选举
Raft 使用一种心跳机制来触发领导人选举。  
当服务器程序启动时，他们都是跟随者身份。一个服务器节点要想继续保持着跟随者状态除非他从领导人或者候选者处接收到有效的 RPCs。领导者周期性的向所有跟随者发送心跳包（不包含日志项内容的附加日志项 RPCs）来维持自己的权威。如果一个跟随者在一段时间里没有接收到任何消息，也就是选举超时，然后他就会认为系统中没有可用的领导者然后开始进行选举以选出新的领导者。

三种状态：
*  自己赢得领导：得到大多数的投票，成为领导，向其他服务发送心跳告知并阻止新领导选举
*  他人赢得领导：收到领导心跳，判断任期，合法变更为跟随者，不合法，继续保持后候选者状态
*  谁也没有成为领导：通过随机选举超时时间的方法保证快速选出领导，减少选票瓜分的情况

# 日志复制
## 日志提交
日志由有序序号标记的条目组成。每个条目都包含创建时的任期号（图中框中的数字），和一个状态机需要执行的指令。一个条目当可以安全的被应用到状态机中去的时候，就认为是可以提交了。  
Raft 算法保证所有已提交的日志条目都是持久化的并且最终会被所有可用的状态机执行。在领导人将创建的日志条目复制到大多数的服务器上的时候，日志条目就会被提交  

![日志提交图](https://github.com/chengnl/thinking/raw/master/images-folder/raft_log_commit.png)


领导人崩溃的情况会使得日志处于不一致的状态，Raft 算法中，领导人处理不一致是通过强制跟随者直接复制自己的日志来解决，跟随者中的冲突的日志条目会被领导人的日志覆盖。
![日志同步图](https://github.com/chengnl/thinking/raw/master/images-folder/raft_log_sync.png)


nextIndex递减检查跟随者日志索引地址条目，nextIndex 会在某个位置使得领导人和跟随者的日志达成一致，当这种情况发生，附加日志 RPC 就会成功，这时就会把跟随者冲突的日志条目全部删除并且加上领导人的日志。一旦附加日志 RPC 成功，那么跟随者的日志就会和领导人保持一致，并且在接下来的任期里一直继续保持。

