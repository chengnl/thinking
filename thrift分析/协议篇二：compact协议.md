# compact协议
  分析thrift二进制压缩协议格式 
  二进制压缩协议相对于二进制协议，主要区别在于各种整形数据，使用变长字节处理和字节合并处理
  
  变长字节处理：
  将整型数字，根据数字大小的占位，每7位做一个字节传递，直到数字所占位传递完为止，从而对固定长度的整数类型，进行压缩传递。

# 协议分析
## 方法调用
方法调用都分为三部分写数据：消息头，参数内容，消息结尾  
其中消息结尾，没有做任何处理，主要关注---消息头|参数内容部分。  

### 一、写消息头

消息头图  

```
--------------------------------------------------------------------
| 1字节协议ID | 1字节版本 | 变长字节序列ID | 变长字节方法名长度 | 方法名内容 |
--------------------------------------------------------------------
```

**1字节协议ID**：取值0x82 

**1字节版本**：取值（压缩版本&压缩版本mask）|（（消息类型ID<<压缩类型移动位数）&压缩类型mask）,即(1&0x1f)|((1<<5)&0x0e0),消息类型：调用，取值1

**变长字节序列ID**：方法调用序列ID，thrift客户端调用方法序列累加计数  ,根据序列ID占用的字节长度，使用变长字节处理

**变长字节方法名长度**：获取方法名字符串长度len(methodName)，然后根据长度占用的字节，使用变长字节处理

**方法名字串**：方法名内容字节  


### 二、写参数内容

写完消息头之后，开始写参数内容，此部分分四部分内容：方法参数结构体开始、参数字段内容、写字段结束、参数结构结尾。其中参数结构体开始和结尾部分，不做任何写处理，可忽略，
主要关注字段和字段结束。参数内容主要是是将各字段的内容写入，最后加写字段结束符 

####2.1参数字段

写字段，首先写入的是参数类型和参数的顺序号    
根据相邻字段间的顺序号差值的大小有不同的处理：  
顺序号差值小于16，将参数类型和顺序号组合为1字节处理，处理方式，1字节组合，顺序号<<4|参数类型： 
``` 
------------------------
| 4位顺序号 | 4位参数类型 | 
------------------------  
```
其中对bool类型，有特殊处理，4位参数类型，直接将bool的值填入

顺序号差值大于15，1字节参数类型，2字节顺序号  
```
------------------------———
| 1字节参数类型 | 2字节顺序号 | 
------------------------———
```

压缩协议参数类型

```
	COMPACT_BOOLEAN_TRUE  = 0x01
	COMPACT_BOOLEAN_FALSE = 0x02
	COMPACT_BYTE          = 0x03
	COMPACT_I16           = 0x04
	COMPACT_I32           = 0x05
	COMPACT_I64           = 0x06
	COMPACT_DOUBLE        = 0x07
	COMPACT_BINARY        = 0x08
	COMPACT_LIST          = 0x09
	COMPACT_SET           = 0x0A
	COMPACT_MAP           = 0x0B
	COMPACT_STRUCT        = 0x0C
```


#####2.1.1参数内容

不同参数类型，在参数内容处理上有所不同，分下面的两种情况：  

1.固定长度类型参数  
  此部分类型有：byte=3、i8=3、i16=6、i32=8、i64=10、double=4  
  此类型的字段，使用变长字节处理 

2.变长类型参数  

  变成类型主要有：string、map、set、list、struct  

  **string类型**  
  ```
------------------------———
| 变长字节内容长度 | 内容字节 | 
------------------------———
```
  **map类型**  
map头处理：  
size为0：
```
---------
| 1字节0 | 
---------
```
size不为0：
```
-----------------------------------———---
| 变长字节size | 1字节key类型<<4和值类型组合 |
-----------------------------------———---
```
然后循环递归key和值内容

  **set和list类型**    
头处理：  
size小于15：
```
------------------------
| 1字节size<<4和值类型组合| 
------------------------
```
size大于等于15：
```
--------------------------
| 1字节类型 | 变长字节size  |
--------------------------
```
然后循环递归值内容

  **struct类型**   
  类似写方法参数，根据struct里面的字段顺序开始写，处理每个字段的字段内容

####2.2字段结束
所有字段写完之后，写入1个字节结束符，该字节值为0


## 方法调用返回

参照方法调用，读取返回的字节。


